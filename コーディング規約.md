# Laravel Webアプリ開発 コーディング規約

## 概要

LaravelとBladeを使用したWebアプリ開発における高品質なソースコード維持のためのコーディング規約です。LaravelのMVCアーキテクチャとPSR（PHP Standard Recommendations）に準拠し、保守性と可読性を重視します。

## 基本原則

- **可読性と保守性を最優先**
- **LaravelのMVCアーキテクチャに準拠**
- **PSR標準に従う**
- **単一責任の原則を守る**
- **一貫性のあるコードスタイル**

## プロジェクト構造

### 推奨ディレクトリ構造

```
app/
├── Http/
│   ├── Controllers/     # コントローラー
│   ├── Requests/        # フォームリクエスト
│   ├── Resources/       # APIリソース
│   └── Middleware/      # ミドルウェア
├── Models/             # Eloquentモデル
├── Services/           # ビジネスロジック
├── Repositories/       # データアクセス層（必要に応じて）
├── Helpers/           # ヘルパークラス
└── Observers/         # Eloquentオブザーバー

resources/
├── views/
│   ├── layouts/        # レイアウトテンプレート
│   ├── components/     # 再利用可能なBladeコンポーネント
│   ├── pages/         # ページ固有のビュー
│   └── emails/        # メールテンプレート
├── css/
├── js/
└── lang/              # 多言語対応

database/
├── migrations/        # データベースマイグレーション
├── seeders/          # シーダー
└── factories/        # モデルファクトリー

tests/
├── Feature/          # 機能テスト
├── Unit/            # 単体テスト
└── TestCase.php     # テスト基底クラス
```

## 命名規則

### PHP クラス・メソッド・変数

| 種別 | 命名規則 | 例 |
|------|----------|-----|
| クラス名 | PascalCase | `UserController`, `OrderService`, `ProductRepository` |
| メソッド名 | camelCase | `getUserProfile()`, `calculateTotal()`, `sendEmail()` |
| 変数名 | camelCase | `$userAccountBalance`, `$totalOrderAmount` |
| 定数 | SCREAMING_SNAKE_CASE | `MAX_LOGIN_ATTEMPTS`, `DEFAULT_PAGINATION_SIZE` |
| プロパティ | camelCase | `$isActive`, `$createdAt` |

### Laravel 固有の命名規則

| 種別 | 命名規則 | 例 |
|------|----------|-----|
| モデル名 | 単数形 PascalCase | `User`, `OrderItem`, `ProductCategory` |
| テーブル名 | 複数形 snake_case | `users`, `order_items`, `product_categories` |
| カラム名 | snake_case | `user_id`, `created_at`, `email_verified_at` |
| コントローラー名 | 複数形 + Controller | `UsersController`, `OrderItemsController` |
| ミドルウェア名 | PascalCase | `AuthMiddleware`, `AdminMiddleware` |

### ファイル・ディレクトリ

| 種別 | 命名規則 | 例 |
|------|----------|-----|
| Bladeファイル | kebab-case | `user-profile.blade.php`, `order-history.blade.php` |
| CSSクラス | kebab-case | `.user-profile-card`, `.btn-primary` |
| JavaScript関数 | camelCase | `initializeComponents()`, `handleFormSubmit()` |

## PHPコーディング規約

### クラス設計

```php
<?php

namespace App\Services;

use App\Models\User;
use App\Notifications\WelcomeNotification;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\ValidationException;

/**
 * ユーザー関連のビジネスロジックを管理するサービスクラス
 */
class UserService
{
    /**
     * 新しいユーザーを作成する
     *
     * @param array $userData ユーザー情報
     * @return User 作成されたユーザー
     * @throws ValidationException バリデーションエラー時
     */
    public function createUser(array $userData): User
    {
        $this->validateUserData($userData);
        
        $user = User::create([
            'name' => $userData['name'],
            'email' => $userData['email'],
            'password' => Hash::make($userData['password']),
        ]);
        
        $this->sendWelcomeNotification($user);
        
        return $user;
    }
    
    /**
     * ユーザーデータのバリデーション
     *
     * @param array $data
     * @throws ValidationException
     */
    private function validateUserData(array $data): void
    {
        $validator = validator($data, [
            'name' => ['required', 'string', 'max:255'],
            'email' => ['required', 'email', 'unique:users'],
            'password' => ['required', 'min:8'],
        ]);
        
        if ($validator->fails()) {
            throw new ValidationException($validator);
        }
    }
    
    /**
     * ウェルカム通知を送信
     *
     * @param User $user
     */
    private function sendWelcomeNotification(User $user): void
    {
        $user->notify(new WelcomeNotification());
    }
}
```

### コントローラー設計

```php
<?php

namespace App\Http\Controllers;

use App\Http\Requests\CreateUserRequest;
use App\Http\Requests\UpdateUserRequest;
use App\Models\User;
use App\Services\UserService;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\View\View;

class UsersController extends Controller
{
    public function __construct(
        private UserService $userService
    ) {}
    
    /**
     * ユーザー一覧表示
     */
    public function index(Request $request): View
    {
        $users = User::query()
            ->when($request->search, function ($query, $search) {
                $query->where('name', 'like', "%{$search}%")
                      ->orWhere('email', 'like', "%{$search}%");
            })
            ->latest()
            ->paginate(15);
            
        return view('users.index', compact('users'));
    }
    
    /**
     * ユーザー作成フォーム表示
     */
    public function create(): View
    {
        return view('users.create');
    }
    
    /**
     * ユーザー作成処理
     */
    public function store(CreateUserRequest $request): RedirectResponse
    {
        try {
            $user = $this->userService->createUser($request->validated());
            
            return redirect()->route('users.show', $user)
                ->with('success', 'ユーザーが正常に作成されました');
                
        } catch (Exception $e) {
            logger()->error('User creation failed', [
                'request' => $request->validated(),
                'error' => $e->getMessage()
            ]);
            
            return back()
                ->with('error', 'ユーザーの作成に失敗しました')
                ->withInput();
        }
    }
    
    /**
     * ユーザー詳細表示
     */
    public function show(User $user): View
    {
        $user->load(['orders', 'profile']);
        
        return view('users.show', compact('user'));
    }
}
```

### モデル設計

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    use HasFactory, Notifiable, SoftDeletes;

    /**
     * 一括代入可能な属性
     *
     * @var array<int, string>
     */
    protected $fillable = [
        'name',
        'email',
        'password',
        'email_verified_at',
    ];

    /**
     * シリアライズ時に非表示にする属性
     *
     * @var array<int, string>
     */
    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * キャストする属性
     *
     * @var array<string, string>
     */
    protected $casts = [
        'email_verified_at' => 'datetime',
        'password' => 'hashed',
        'created_at' => 'datetime',
        'updated_at' => 'datetime',
    ];

    /**
     * 注文との関連
     */
    public function orders(): HasMany
    {
        return $this->hasMany(Order::class);
    }

    /**
     * プロファイルとの関連
     */
    public function profile(): BelongsTo
    {
        return $this->belongsTo(UserProfile::class);
    }

    /**
     * フルネームのアクセサ
     */
    public function getFullNameAttribute(): string
    {
        return trim("{$this->first_name} {$this->last_name}");
    }

    /**
     * アクティブなユーザーのスコープ
     */
    public function scopeActive($query)
    {
        return $query->whereNotNull('email_verified_at');
    }

    /**
     * 最近作成されたユーザーのスコープ
     */
    public function scopeRecent($query, int $days = 30)
    {
        return $query->where('created_at', '>=', now()->subDays($days));
    }
}
```

## Blade テンプレート規約

### レイアウト構造

```blade
{{-- resources/views/layouts/app.blade.php --}}
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>@yield('title', config('app.name'))</title>

    {{-- Fonts --}}
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=figtree:400,500,600&display=swap" rel="stylesheet" />

    {{-- Scripts & Styles --}}
    @vite(['resources/css/app.css', 'resources/js/app.js'])
    @stack('styles')
</head>
<body class="font-sans antialiased bg-gray-50">
    <div class="min-h-screen">
        {{-- ナビゲーション --}}
        @include('layouts.navigation')

        {{-- ページヘッダー --}}
        @hasSection('header')
            <header class="bg-white shadow">
                <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                    @yield('header')
                </div>
            </header>
        @endif

        {{-- フラッシュメッセージ --}}
        @if(session('success'))
            <x-alert type="success" :message="session('success')" />
        @endif

        @if(session('error'))
            <x-alert type="error" :message="session('error')" />
        @endif

        {{-- メインコンテンツ --}}
        <main>
            @yield('content')
        </main>
    </div>

    @stack('scripts')
</body>
</html>
```

### ページビュー

```blade
{{-- resources/views/users/index.blade.php --}}
@extends('layouts.app')

@section('title', 'ユーザー一覧')

@section('header')
    <div class="flex justify-between items-center">
        <h2 class="font-semibold text-xl text-gray-800 leading-tight">
            ユーザー一覧
        </h2>
        <a href="{{ route('users.create') }}" class="btn btn-primary">
            新規ユーザー作成
        </a>
    </div>
@endsection

@section('content')
<div class="py-12">
    <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
        {{-- 検索フォーム --}}
        <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg mb-6">
            <div class="p-6 border-b border-gray-200">
                <form method="GET" action="{{ route('users.index') }}" class="flex gap-4">
                    <div class="flex-1">
                        <input type="text" 
                               name="search" 
                               value="{{ request('search') }}"
                               placeholder="名前またはメールアドレスで検索"
                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <button type="submit" class="btn btn-secondary">
                        検索
                    </button>
                    @if(request('search'))
                        <a href="{{ route('users.index') }}" class="btn btn-outline">
                            クリア
                        </a>
                    @endif
                </form>
            </div>
        </div>

        {{-- ユーザー一覧 --}}
        <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
            @if($users->count() > 0)
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ユーザー
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ステータス
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    登録日
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    アクション
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @foreach($users as $user)
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                <img class="h-10 w-10 rounded-full" 
                                                     src="{{ $user->avatar_url ?? 'https://ui-avatars.com/api/?name=' . urlencode($user->name) }}" 
                                                     alt="{{ $user->name }}">
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">
                                                    {{ $user->name }}
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    {{ $user->email }}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <x-status-badge :active="$user->email_verified_at" />
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ $user->created_at->format('Y/m/d') }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <a href="{{ route('users.show', $user) }}" 
                                           class="text-indigo-600 hover:text-indigo-900">詳細</a>
                                        <a href="{{ route('users.edit', $user) }}" 
                                           class="text-indigo-600 hover:text-indigo-900">編集</a>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>

                {{-- ページネーション --}}
                <div class="px-6 py-4 border-t border-gray-200">
                    {{ $users->appends(request()->query())->links() }}
                </div>
            @else
                <x-empty-state 
                    message="ユーザーが見つかりません" 
                    description="新しいユーザーを作成してください"
                    action-url="{{ route('users.create') }}"
                    action-text="ユーザー作成" />
            @endif
        </div>
    </div>
</div>
@endsection
```

### Bladeコンポーネント

```blade
{{-- resources/views/components/alert.blade.php --}}
@props(['type' => 'info', 'message'])

@php
$classes = match($type) {
    'success' => 'bg-green-50 border-green-200 text-green-800',
    'error' => 'bg-red-50 border-red-200 text-red-800',
    'warning' => 'bg-yellow-50 border-yellow-200 text-yellow-800',
    default => 'bg-blue-50 border-blue-200 text-blue-800',
};

$iconClasses = match($type) {
    'success' => 'text-green-400',
    'error' => 'text-red-400',
    'warning' => 'text-yellow-400',
    default => 'text-blue-400',
};
@endphp

<div {{ $attributes->merge(['class' => "rounded-md border p-4 {$classes}"]) }}>
    <div class="flex">
        <div class="flex-shrink-0">
            @if($type === 'success')
                <svg class="h-5 w-5 {{ $iconClasses }}" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
            @elseif($type === 'error')
                <svg class="h-5 w-5 {{ $iconClasses }}" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            @endif
        </div>
        <div class="ml-3">
            <p class="text-sm">{{ $message }}</p>
        </div>
    </div>
</div>
```

## データベース規約

### マイグレーション設計

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * マイグレーション実行
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
            $table->softDeletes();
            
            // インデックス
            $table->index(['email', 'created_at']);
            $table->index('email_verified_at');
        });
    }

    /**
     * マイグレーション取り消し
     */
    public function down(): void
    {
        Schema::dropIfExists('users');
    }
};
```

### シーダー設計

```php
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;

class UserSeeder extends Seeder
{
    /**
     * シード実行
     */
    public function run(): void
    {
        // 管理者ユーザー作成
        User::create([
            'name' => 'Administrator',
            'email' => 'admin@example.com',
            'password' => Hash::make('password'),
            'email_verified_at' => now(),
        ]);
        
        // テストユーザー作成
        if (app()->environment(['local', 'staging'])) {
            User::factory(50)->create();
        }
    }
}
```

## フォームリクエスト

```php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Validation\Rules\Password;

class CreateUserRequest extends FormRequest
{
    /**
     * リクエストを実行する権限があるかを判定
     */
    public function authorize(): bool
    {
        return auth()->check() && auth()->user()->can('create', User::class);
    }

    /**
     * バリデーションルール
     */
    public function rules(): array
    {
        return [
            'name' => ['required', 'string', 'max:255'],
            'email' => ['required', 'email', 'max:255', 'unique:users'],
            'password' => ['required', 'confirmed', Password::defaults()],
        ];
    }

    /**
     * カスタムエラーメッセージ
     */
    public function messages(): array
    {
        return [
            'name.required' => '名前は必須です。',
            'email.required' => 'メールアドレスは必須です。',
            'email.email' => '有効なメールアドレスを入力してください。',
            'email.unique' => 'このメールアドレスは既に使用されています。',
            'password.required' => 'パスワードは必須です。',
            'password.confirmed' => 'パスワード確認が一致しません。',
        ];
    }

    /**
     * バリデーション後の処理
     */
    public function passedValidation(): void
    {
        $this->merge([
            'email' => strtolower($this->email),
        ]);
    }
}
```

## セキュリティ規約

### SQLインジェクション対策

```php
// ✅ Good: Eloquent使用
$users = User::where('status', 'active')
    ->where('created_at', '>=', $date)
    ->get();

// ✅ Good: クエリビルダーでのバインディング
$users = DB::table('users')
    ->where('email', $email)
    ->where('status', '!=', 'banned')
    ->get();

// ✅ Good: 名前付きバインディング
$users = DB::select('SELECT * FROM users WHERE email = :email AND status = :status', [
    'email' => $email,
    'status' => 'active'
]);

// ❌ Bad: 生SQLの直接結合（絶対に避ける）
$users = DB::select("SELECT * FROM users WHERE email = '$email'");
```

### XSS対策

```blade
{{-- ✅ Good: 自動エスケープ --}}
<p>{{ $user->name }}</p>
<input type="text" value="{{ $user->email }}">

{{-- ✅ Good: HTMLを含む場合はサニタイズ --}}
<div>{!! clean($user->bio) !!}</div>

{{-- ❌ Bad: 生HTML出力（信頼できるデータのみ） --}}
<div>{!! $user->bio !!}</div>
```

### CSRF対策

```blade
{{-- フォームにCSRFトークン必須 --}}
<form method="POST" action="{{ route('users.store') }}">
    @csrf
    <!-- フォーム内容 -->
    <button type="submit">作成</button>
</form>

{{-- Ajax通信時 --}}
<meta name="csrf-token" content="{{ csrf_token() }}">
<script>
$.ajaxSetup({
    headers: {
        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
    }
});
</script>
```

## テスト規約

### 機能テスト

```php
<?php

namespace Tests\Feature;

use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class UserManagementTest extends TestCase
{
    use RefreshDatabase;

    /**
     * ユーザー一覧表示テスト
     */
    public function test_users_index_displays_users(): void
    {
        $users = User::factory()->count(3)->create();
        
        $response = $this->actingAs(User::factory()->create())
            ->get(route('users.index'));

        $response->assertStatus(200)
            ->assertViewIs('users.index')
            ->assertViewHas('users');
            
        foreach ($users as $user) {
            $response->assertSee($user->name)
                ->assertSee($user->email);
        }
    }

    /**
     * ユーザー作成テスト
     */
    public function test_user_can_be_created(): void
    {
        $userData = [
            'name' => 'Test User',
            'email' => 'test@example.com',
            'password' => 'password123',
            'password_confirmation' => 'password123',
        ];

        $response = $this->actingAs(User::factory()->create())
            ->post(route('users.store'), $userData);

        $response->assertRedirect();
        $this->assertDatabaseHas('users', [
            'name' => 'Test User',
            'email' => 'test@example.com',
        ]);
    }

    /**
     * バリデーションエラーテスト
     */
    public function test_user_creation_requires_valid_data(): void
    {
        $response = $this->actingAs(User::factory()->create())
            ->post(route('users.store'), []);

        $response->assertSessionHasErrors(['name', 'email', 'password']);
    }
}
```

### 単体テスト

```php
<?php

namespace Tests\Unit;

use App\Models\User;
use App\Services\UserService;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class UserServiceTest extends TestCase
{
    use RefreshDatabase;

    private UserService $userService;

    protected function setUp(): void
    {
        parent::setUp();
        $this->userService = app(UserService::class);
    }

    /**
     * ユーザー作成テスト
     */
    public function test_creates_user_successfully(): void
    {
        $userData = [
            'name' => 'John Doe',
            'email' => 'john@example.com',
            'password' => 'password123',
        ];

        $user = $this->userService->createUser($userData);

        $this->assertInstanceOf(User::class, $user);
        $this->assertEquals('John Doe', $user->name);
        $this->assertEquals('john@example.com', $user->email);
        $this->assertDatabaseHas('users', [
            'email' => 'john@example.com'
        ]);
    }

    /**
     * バリデーションエラーテスト
     */
    public function test_throws_validation_exception_for_invalid_data(): void
    {
        $this->expectException(ValidationException::class);
        
        $this->userService->createUser([
            'name' => '',
            'email' => 'invalid-email',
        ]);
    }
}
```

## パフォーマンス規約

### N+1クエリ対策

```php
// ❌ Bad: N+1クエリが発生
public function index()
{
    $users = User::all();
    
    foreach ($users as $user) {
        echo $user->profile->bio; // 各ユーザーごとにクエリ実行
    }
}

// ✅ Good: Eager Loading
public function index()
{
    $users = User::with(['profile', 'orders'])->get();
    
    foreach ($users as $user) {
        echo $user->profile->bio; // 追加クエリなし
    }
}

// ✅ Good: 遅延Eager Loading
public function index()
{
    $users = User::all();
    
    if ($users->isNotEmpty()) {
        $users->load(['profile', 'orders']);
    }
}
```

### キャッシュ戦略

```php
// ✅ Good: 適切なキャッシュ使用
public function getPopularProducts()
{
    return Cache::remember('popular_products', 3600, function () {
        return Product::where('is_popular', true)
            ->with('category')
            ->orderBy('sales_count', 'desc')
            ->limit(10)
            ->get();
    });
}

// ✅ Good: ページネーションのキャッシュ
public function index(Request $request)
{
    $page = $request->get('page', 1);
    $cacheKey = "users_page_{$page}";
    
    $users = Cache::remember($cacheKey, 1800, function () use ($request) {
        return User::latest()->paginate(15);
    });
    
    return view('users.index', compact('users'));
}
```

## エラーハンドリング

### 例外処理

```php
// app/Exceptions/Handler.php
public function render($request, Throwable $exception)
{
    // カスタム例外処理
    if ($exception instanceof UserNotFoundException) {
        return response()->view('errors.user-not-found', [], 404);
    }
    
    if ($exception instanceof ValidationException) {
        return back()
            ->withErrors($exception->validator)
            ->withInput();
    }
    
    // ログ記録
    if ($exception instanceof \Exception) {
        Log::error('Unexpected error occurred', [
            'exception' => $exception->getMessage(),
            'file' => $exception->getFile(),
            'line' => $exception->getLine(),
            'trace' => $exception->getTraceAsString(),
        ]);
    }
    
    return parent::render($request, $exception);
}
```

### カスタム例外

```php
<?php

namespace App\Exceptions;

use Exception;

class UserNotFoundException extends Exception
{
    protected $message = 'ユーザーが見つかりません';
    
    public function __construct($message = null)
    {
        parent::__construct($message ?? $this->message);
    }
    
    public function render()
    {
        return response()->view('errors.404', [
            'message' => $this->getMessage()
        ], 404);
    }
}
```

## 自動化・品質管理

### Composer設定

```json
{
    "scripts": {
        "test": "vendor/bin/phpunit",
        "test-coverage": "vendor/bin/phpunit --coverage-html coverage",
        "cs-fix": "vendor/bin/php-cs-fixer fix",
        "cs-check": "vendor/bin/php-cs-fixer fix --dry-run --diff",
        "analyse": "vendor/bin/phpstan analyse",
        "ide-helper": [
            "@php artisan ide-helper:generate",
            "@php artisan ide-helper:models",
            "@php artisan ide-helper:meta"
        ]
    }
}
```

### GitHub Actions設定例

```yaml
# .github/workflows/tests.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress
    
    - name: Run code style check
      run: composer run cs-check
    
    - name: Run static analysis
      run: composer run analyse
    
    - name: Run tests
      run: composer run test
```

### 必須開発ツール

| ツール | 用途 | コマンド |
|--------|------|----------|
| Laravel Pint | コードスタイル自動修正 | `./vendor/bin/pint` |
| PHPStan | 静的解析 | `./vendor/bin/phpstan analyse` |
| PHPUnit | テスト実行 | `./vendor/bin/phpunit` |
| Laravel IDE Helper | IDE支援 | `php artisan ide-helper:generate` |

## まとめ

この規約は以下の原則に基づいています：

1. **一貫性**: チーム全体で統一されたコードスタイル
2. **可読性**: 誰でも理解しやすいコード
3. **保守性**: 変更・拡張しやすい構造
4. **セキュリティ**: 安全なコードの実装
5. **パフォーマンス**: 効率的なアプリケーション

SQLiteから他のデータベースへの移行も考慮し、Eloquent ORMを積極的に活用することで、将来の変更に柔軟に対応できるようになっています。

定期的な見直しとチームでの議論を通じて、プロジェクトに最適な形に進化させていくことが重要です。
